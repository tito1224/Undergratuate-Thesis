---
title: "Process to Create Errors in Point Count Data"
author: "Simon"
date: "2022-11-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set Variables
```{r}
library(tidyverse)
```


```{r}
source("./Functions/generatePointCount_sjb.R")
```

```{r}
p_1m = 0.6 # needs to be the same p_1m I use to generate summarized count data
maxMinute = 5
psi=0.6
n_locations = 50
lambda = 15 # get this number from some data?
alpha = 0.3
```

```{r}
set.seed(1)
locationID = 1:n_locations
#N_i = rpois(n_locations,lambda)
N_i = rnbinom(n_locations, mu = lambda, size= 1)
```

The function `generateDetects()` simulates detections for each individual at each location. The data is stored as a dataframe with columns for location, indiviual, minute, and detection. I like this way of storing the data because it makes it easier to do manipulations that depend on the minute (e.g., splitting the histories).

```{r}
# Generate data
pcData <- generateDetects(N_i, p_1m, maxMinute, 7777)

# Examine the first few rows
head(pcData)
```
In this example, the first individual at location 1 was observed in minutes 1, 2, and 5.

I created a helper function called `detectsToCapHist()` that consolidates the data for each individual at each location into a single row. The new variables called Minute1, Minute2, etc. identify whether the individual was captured in each minute. The function has an argument `keep_zeros` that determines whether individuals with no detections are kept or removed. The default is `FALSE` which removes the indivudlas that were never detected. 

```{r}
## Construct capture histories keeping only individuals detected at least once
chData <- detectsToCapHist(pcData)

## Examine first few rows
head(chData)
```

The next function `generateMovement()` simulates movments for each individual in the data set. If we assume that the probability of moving is the same in each minute for all individuals at all location, $\alpha$, then we can simply generate a long vector of Bernoulli random variables with probability $\alpha$ to determine movements. Note that the variable `Move` in my datset actually indicates whether the individual moves after minute `m-1` and before minute `m`. E.g., if `Move=1` for minute two then the individual moved between minute 1 and 2. By construction, `Move = 0` for minute 1 for all individuals.

```{r}
## Simulate movements
moveData <- generateMovement(pcData, alpha, seed = 8888)

## Examine first few rows
head(moveData)
```
In this example, the first individual at location 1 moved between minutes 2 and 3. This means that it will contribute two observed histories once the data is split: 11000 and 00001.  

The final function, `splitDetects()`, splits the detection histories according to the movements. It does this by generating a new variable `Split` which is equal to the cumulative sum of the movements for each individual (plus 1 to avoid values of 0). These values show how the minutes are broken into the new capture histories. The function then creates a new individual id by concatenating the original individual id with `Split` (this was your idea and its very elegant) and then completes the data set to fill in missing 0s in `Detect`.

```{r}
## Split detects
splitData <- splitDetects(moveData)

## Examine first few rows
print(splitData, n = 10)
```
The printout above shows the first 10 rows of the data, which contain the detections for the three different histories generated by the movements of individual 1. 

The `detectsToCapHist()` function can then be used again to convert the list of detections to wide data with capture histories across the columns. By default this will remove capture histories with no detections after the split and only return the observed histories. 
```{r}
## Construct capture histories keeping only individuals detected at least once
chData1 <- detectsToCapHist(splitData)

## Examine first few rows
head(chData1)
```
Here we see the two observed histories for individual 1 at location 1. Note that the histories from individual 3 are labelled `3_1` and `3_3`. This is because the bird move twice and was not detected between the two moves. As a result, a history was created with no detects and was removed from the data. We can see it if we rerun `detectsToCapHist()` with `keepZeros = TRUE`.
```{r}
## Construct capture histories keeping only individuals detected at least once
chData1b <- detectsToCapHist(splitData, keepZeros = TRUE)

## Examine first few rows
head(chData1b)
```